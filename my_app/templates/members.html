{% extends 'layout/dashboard_base.html' %} 
{% load static %}
{% block content %}
<div class="main-content-container overflow-hidden">
	<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
		<h3 class="mb-0">
			<i class="ri-team-line"></i> Members Management
		</h3>

		<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center mb-0 lh-1">
				<li class="breadcrumb-item">
					<a href="{% url 'dashboard' %}" class="d-flex align-items-center text-decoration-none">
						<i class="ri-home-4-line fs-18 text-primary me-1"></i>
						<span class="text-secondary fw-medium hover">Dashboard</span>
					</a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">
					<span class="fw-medium">Members</span>
				</li>
			</ol>
		</nav>
	</div>

	<!-- Staff Access Only Notice -->
	<div class="alert alert-info d-flex align-items-center" role="alert">
		<i class="ri-shield-check-line fs-20 me-2"></i>
		<div>
			<strong>Staff Access Only:</strong> This page is restricted to staff members only. You have access to view and manage all user accounts.
		</div>
	</div>

	<!-- Statistics Cards -->
	<div class="row mb-4">
		<div class="col-lg-3 col-sm-6">
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-body p-4">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<span class="d-block mb-1 text-secondary">Total Users</span>
							<h3 class="fw-bold mb-0 text-primary">{{ total_users }}</h3>
						</div>
						<div class="bg-primary bg-opacity-10 rounded-3 p-3">
							<i class="ri-user-line fs-24 text-primary"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-3 col-sm-6">
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-body p-4">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<span class="d-block mb-1 text-secondary">Staff Users</span>
							<h3 class="fw-bold mb-0 text-success">{{ staff_users }}</h3>
						</div>
						<div class="bg-success bg-opacity-10 rounded-3 p-3">
							<i class="ri-shield-user-line fs-24 text-success"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-3 col-sm-6">
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-body p-4">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<span class="d-block mb-1 text-secondary">Active Users</span>
							<h3 class="fw-bold mb-0 text-info">{{ active_users }}</h3>
						</div>
						<div class="bg-info bg-opacity-10 rounded-3 p-3">
							<i class="ri-user-smile-line fs-24 text-info"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-3 col-sm-6">
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-body p-4">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<span class="d-block mb-1 text-secondary">With Profiles</span>
							<h3 class="fw-bold mb-0 text-warning">{{ users_with_profiles }}</h3>
						</div>
						<div class="bg-warning bg-opacity-10 rounded-3 p-3">
							<i class="ri-user-settings-line fs-24 text-warning"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Search and Filter -->
	<div class="card bg-white border-0 rounded-3 mb-4">
		<div class="card-body p-4">
			<form method="get" class="row align-items-end">
				<div class="col-lg-6">
					<label class="label text-secondary">Search Members</label>
					<input 
						type="text" 
						name="search" 
						class="form-control h-55" 
						placeholder="Search by username, name, or email..."
						value="{{ search_query }}"
					>
				</div>
				<div class="col-lg-3">
					<button type="submit" class="btn btn-primary h-55 w-100">
						<i class="ri-search-line"></i> Search
					</button>
				</div>
				<div class="col-lg-3">
					{% if search_query %}
						<a href="{% url 'members' %}" class="btn btn-outline-secondary h-55 w-100">
							<i class="ri-refresh-line"></i> Clear
						</a>
					{% endif %}
				</div>
			</form>
		</div>
	</div>

	<!-- Members Table -->
	<div class="card bg-white border-0 rounded-3 mb-4">
		<div class="card-body p-0">
			<div class="default-table-area all-products">
				<div class="table-responsive">
					<table class="table align-middle mb-0">
						<thead class="table-light">
							<tr>
								<th scope="col" class="ps-4">ID</th>
								<th scope="col">Member</th>
								<th scope="col">Email</th>
								<th scope="col">Status</th>
								<th scope="col">Profile</th>
								<th scope="col">Joined</th>
								<th scope="col">Last Login</th>
								<th scope="col" class="pe-4">Action</th>
							</tr>
						</thead>
						<tbody>
							{% for user in page_obj %}
							<tr>
								<td class="ps-4">
									<span class="fw-medium text-secondary">#{{ user.id }}</span>
								</td>
								<td>
									<div class="d-flex align-items-center">
										{% if user.profile.profile_picture %}
											<img src="{{ user.profile.profile_picture.url }}" 
											     class="wh-44 rounded-circle me-3" 
											     alt="{{ user.get_full_name|default:user.username }}">
										{% else %}
											<img src="{% static 'images/user-default.png' %}" 
											     class="wh-44 rounded-circle me-3" 
											     alt="{{ user.get_full_name|default:user.username }}">
										{% endif %}
										<div>
											<h6 class="fw-medium fs-15 mb-0">
												{{ user.get_full_name|default:user.username }}
											</h6>
											<span class="fs-13 text-body">@{{ user.username }}</span>
										</div>
									</div>
								</td>
								<td>
									<span class="text-body">{{ user.email }}</span>
								</td>
								<td>
									{% if user.is_superuser %}
										<span class="badge bg-danger bg-opacity-10 text-danger fs-12 fw-medium">Super Admin</span>
									{% elif user.is_staff %}
										<span class="badge bg-success bg-opacity-10 text-success fs-12 fw-medium">Staff</span>
									{% elif user.is_active %}
										<span class="badge bg-primary bg-opacity-10 text-primary fs-12 fw-medium">Active</span>
									{% else %}
										<span class="badge bg-secondary bg-opacity-10 text-secondary fs-12 fw-medium">Inactive</span>
									{% endif %}
								</td>
								<td>
									{% if user.profile %}
										<span class="badge bg-success bg-opacity-10 text-success fs-12 fw-medium">
											<i class="ri-check-line"></i> Complete
										</span>
									{% else %}
										<span class="badge bg-warning bg-opacity-10 text-warning fs-12 fw-medium">
											<i class="ri-close-line"></i> Incomplete
										</span>
									{% endif %}
								</td>
								<td>
									<span class="text-body">{{ user.date_joined|date:"M d, Y" }}</span>
								</td>
								<td>
									{% if user.last_login %}
										<span class="text-body">{{ user.last_login|date:"M d, Y" }}</span>
									{% else %}
										<span class="text-muted">Never</span>
									{% endif %}
								</td>
								<td class="pe-4">
									<div class="d-flex align-items-center gap-1">
										<a href="{% url 'my-profile' %}?user={{ user.id }}" 
										   class="btn btn-success btn-sm" 
										   title="View Profile">
											<i class="ri-eye-line"></i>
										</a>
										{% if user.profile %}
											<button type="button" 
											        class="btn btn-info btn-sm" 
											        title="User Info"
											        data-bs-toggle="modal" 
											        data-bs-target="#userModal{{ user.id }}">
												<i class="ri-information-line"></i>
											</button>
										{% endif %}
									</div>
								</td>
							</tr>
							{% empty %}
							<tr>
								<td colspan="8" class="text-center py-4">
									<div class="d-flex flex-column align-items-center">
										<i class="ri-user-line fs-48 text-muted mb-2"></i>
										<h6 class="fw-medium text-muted">No members found</h6>
										{% if search_query %}
											<p class="text-muted mb-0">Try adjusting your search criteria</p>
										{% endif %}
									</div>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- Pagination -->
	{% if page_obj.has_other_pages %}
	<div class="card bg-white border-0 rounded-3">
		<div class="card-body p-4">
			<div class="d-flex justify-content-between align-items-center">
				<div>
					<p class="mb-0 text-muted">
						Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} members
					</p>
				</div>
				<nav aria-label="Page navigation">
					<ul class="pagination mb-0">
						{% if page_obj.has_previous %}
							<li class="page-item">
								<a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">
									<i class="ri-arrow-left-double-line"></i>
								</a>
							</li>
							<li class="page-item">
								<a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
									<i class="ri-arrow-left-line"></i>
								</a>
							</li>
						{% endif %}
						
						{% for num in page_obj.paginator.page_range %}
							{% if page_obj.number == num %}
								<li class="page-item active">
									<span class="page-link">{{ num }}</span>
								</li>
							{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
								<li class="page-item">
									<a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
								</li>
							{% endif %}
						{% endfor %}
						
						{% if page_obj.has_next %}
							<li class="page-item">
								<a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
									<i class="ri-arrow-right-line"></i>
								</a>
							</li>
							<li class="page-item">
								<a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">
									<i class="ri-arrow-right-double-line"></i>
								</a>
							</li>
						{% endif %}
					</ul>
				</nav>
			</div>
		</div>
	</div>
	{% endif %}
</div>

<!-- User Info Modals -->
{% for user in page_obj %}
{% if user.profile %}
<div class="modal fade" id="userModal{{ user.id }}" tabindex="-1" aria-labelledby="userModalLabel{{ user.id }}" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="userModalLabel{{ user.id }}">
					<i class="ri-user-line"></i> {{ user.get_full_name|default:user.username }}
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-md-4 text-center">
						{% if user.profile.profile_picture %}
							<img src="{{ user.profile.profile_picture.url }}" 
							     class="rounded-circle mb-3" 
							     style="width: 120px; height: 120px; object-fit: cover;"
							     alt="{{ user.get_full_name|default:user.username }}">
						{% else %}
							<img src="{% static 'images/user-default.png' %}" 
							     class="rounded-circle mb-3" 
							     style="width: 120px; height: 120px; object-fit: cover;"
							     alt="{{ user.get_full_name|default:user.username }}">
						{% endif %}
						<h6 class="fw-medium">{{ user.get_full_name|default:user.username }}</h6>
						<p class="text-muted mb-0">@{{ user.username }}</p>
					</div>
					<div class="col-md-8">
						<h6 class="fw-medium mb-3">User Information</h6>
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Email:</strong></div>
							<div class="col-sm-8">{{ user.email }}</div>
						</div>
						{% if user.profile.phone_number %}
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Phone:</strong></div>
							<div class="col-sm-8">{{ user.profile.phone_number }}</div>
						</div>
						{% endif %}
						{% if user.profile.address %}
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Address:</strong></div>
							<div class="col-sm-8">{{ user.profile.address }}</div>
						</div>
						{% endif %}
						{% if user.profile.country %}
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Country:</strong></div>
							<div class="col-sm-8">{{ user.profile.country }}</div>
						</div>
						{% endif %}
						{% if user.profile.display_profession %}
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Profession:</strong></div>
							<div class="col-sm-8">{{ user.profile.display_profession }}</div>
						</div>
						{% endif %}
						{% if user.profile.company_name %}
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Company:</strong></div>
							<div class="col-sm-8">{{ user.profile.company_name }}</div>
						</div>
						{% endif %}
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Joined:</strong></div>
							<div class="col-sm-8">{{ user.date_joined|date:"F d, Y" }}</div>
						</div>
						<div class="row mb-2">
							<div class="col-sm-4"><strong>Last Login:</strong></div>
							<div class="col-sm-8">
								{% if user.last_login %}
									{{ user.last_login|date:"F d, Y g:i A" }}
								{% else %}
									Never logged in
								{% endif %}
							</div>
						</div>
					</div>
				</div>
				{% if user.profile.bio %}
				<hr>
				<h6 class="fw-medium mb-2">Bio</h6>
				<p class="text-muted">{{ user.profile.bio }}</p>
				{% endif %}
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<a href="{% url 'my-profile' %}?user={{ user.id }}" class="btn btn-primary">View Full Profile</a>
			</div>
		</div>
	</div>
</div>
{% endif %}
{% endfor %}
{% endblock %}
